# 微信文章格式化与海报生成系统 - 开发手册

## 1. 系统概述

### 1.1 项目目标
开发一个Web应用程序，允许用户复制文章内容，系统自动格式化为Markdown，并基于文章内容AI生成匹配的海报，提供下载功能。

### 1.2 核心功能
- 文章复制与粘贴
- 自动Markdown格式化
- AI海报生成
- 海报下载功能
- 大模型API配置

### 1.3 技术栈
- 后端：Python + Flask
- 前端：HTML + CSS + JavaScript + Bootstrap
- 数据库：SQLite
- AI服务：OpenAI API / Claude API / 自定义API
- 图像处理：WeasyPrint + Pillow

## 2. 系统架构设计

### 2.1 整体架构
```
前端界面 → Flask后端 → 业务逻辑层 → 数据库层
                ↓
            AI服务API → 图像生成 → 海报下载
```

### 2.2 模块划分
- **前端模块**：用户界面、交互逻辑
- **后端模块**：API接口、业务逻辑
- **服务模块**：AI调用、图像处理、文件管理
- **数据模块**：数据存储、配置管理

### 2.3 扩展性设计
- 预留用户系统扩展接口
- 模块化设计支持功能扩展
- 配置化AI服务接入

## 3. 数据库设计

### 3.1 核心表结构

#### 文章表 (articles)
```sql
CREATE TABLE articles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    formatted_content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 海报表 (posters)
```sql
CREATE TABLE posters (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    article_id INTEGER NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    image_path VARCHAR(500),
    template_type VARCHAR(50),
    style_type VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (article_id) REFERENCES articles(id)
);
```

#### 配置表 (configs)
```sql
CREATE TABLE configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 预留用户系统扩展

#### 预留用户表 (users)
```sql
-- 未来扩展时创建
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);
```

#### 预留文章表扩展字段
```sql
-- 未来在articles表中添加
ALTER TABLE articles ADD COLUMN user_id INTEGER;
ALTER TABLE articles ADD FOREIGN KEY (user_id) REFERENCES users(id);
```

## 4. API接口设计

### 4.1 文章管理接口

#### 文章相关
- `POST /api/articles` - 创建新文章
- `GET /api/articles/{id}` - 获取文章详情
- `PUT /api/articles/{id}` - 更新文章内容
- `DELETE /api/articles/{id}` - 删除文章

#### 格式化接口
- `POST /api/articles/{id}/format` - 格式化文章为Markdown
- `GET /api/articles/{id}/formatted` - 获取格式化后的内容

### 4.2 海报管理接口

#### 海报生成
- `POST /api/posters/generate` - 生成海报
- `GET /api/posters/{id}` - 获取海报信息
- `GET /api/posters/{id}/download` - 下载海报
- `DELETE /api/posters/{id}` - 删除海报

#### 模板管理
- `GET /api/templates` - 获取可用模板列表
- `GET /api/templates/{type}` - 获取特定模板详情

### 4.3 配置管理接口

#### 系统配置
- `GET /api/configs` - 获取系统配置
- `PUT /api/configs/{key}` - 更新配置项
- `POST /api/configs/test-ai` - 测试AI服务连接

### 4.4 预留用户系统接口

#### 用户管理（预留）
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/profile` - 获取用户信息

## 5. 前端设计

### 5.1 页面结构

#### 主页面 (index.html)
- 文章输入区域
- 格式化按钮
- 海报生成区域
- 配置管理区域

#### 配置页面 (config.html)
- AI服务配置
- 模板选择
- 系统设置

### 5.2 功能模块

#### 文章编辑器
- 支持富文本粘贴
- 实时预览功能
- 格式化操作按钮

#### 海报预览
- 实时预览生成效果
- 模板选择器
- 样式调整选项

#### 下载管理
- 海报下载按钮
- 格式选择（PNG/JPG）
- 质量设置

### 5.3 预留用户界面

#### 登录/注册（预留）
- 登录表单
- 注册表单
- 用户信息展示

## 6. 后端设计

### 6.1 Flask应用结构

#### 应用初始化
- 数据库连接配置
- 路由注册
- 中间件设置

#### 模块组织
- `app/` - 应用主目录
- `app/models/` - 数据模型
- `app/services/` - 业务逻辑
- `app/api/` - API接口
- `app/utils/` - 工具函数

### 6.2 服务层设计

#### AI服务
- AI API调用封装
- 多AI服务支持
- 错误处理和重试

#### 图像处理服务
- HTML到图像转换
- 图片尺寸调整
- 格式转换

#### 文件管理服务
- 临时文件管理
- 文件清理机制
- 路径管理

### 6.3 预留用户认证

#### 认证中间件（预留）
- JWT令牌处理
- 用户身份验证
- 权限控制

## 7. 核心功能实现

### 7.1 文章格式化流程

#### 格式化规则
1. 清理多余的空白字符
2. 识别段落结构
3. 处理标题层级
4. 格式化列表和引用
5. 生成Markdown语法

#### 实现要点
- 正则表达式处理
- 段落智能识别
- 格式一致性保证

### 7.2 海报生成流程

#### 生成步骤
1. 解析文章内容
2. 提取关键信息
3. 构建AI提示词
4. 调用AI服务
5. 生成HTML模板
6. 转换为图像

#### 模板系统
- 小红书模板（3:4比例）
- 公众号模板（3.35:1比例）
- 自定义模板支持

### 7.3 AI集成

#### 提示词工程
- 基于现有提示词库
- 动态参数替换
- 风格化控制

#### 多AI服务支持
- OpenAI GPT系列
- Claude系列
- 自定义API接口

## 8. 部署和配置

### 8.1 环境要求
- Python 3.8+
- SQLite3
- 现代Web浏览器

### 8.2 安装步骤
1. 克隆项目代码
2. 安装依赖包
3. 配置环境变量
4. 初始化数据库
5. 启动应用服务

### 8.3 配置文件

#### 环境变量 (.env)
```
FLASK_ENV=development
FLASK_DEBUG=True
DATABASE_URL=sqlite:///app.db
AI_SERVICE_URL=https://api.openai.com/v1
AI_API_KEY=your_api_key_here
```

#### 应用配置 (config.py)
- 数据库配置
- AI服务配置
- 文件存储配置
- 安全设置

### 8.4 运行方式

#### 开发环境
```bash
python app.py
```

#### 生产环境
```bash
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

## 9. 扩展计划

### 9.1 用户系统
- 用户注册和登录
- 用户内容管理
- 权限控制

### 9.2 功能增强
- 多种海报模板
- 批量处理功能
- 历史记录管理

### 9.3 性能优化
- 缓存机制
- 异步处理
- 数据库优化

## 10. 注意事项

### 10.1 安全考虑
- AI API密钥安全
- 文件上传安全
- 输入数据验证

### 10.2 性能考虑
- 大文件处理优化
- 并发请求处理
- 内存使用管理

### 10.3 维护考虑
- 日志记录
- 错误监控
- 定期备份

---

*注：本开发手册专注于系统架构和功能设计，具体代码实现请参考项目源码。*